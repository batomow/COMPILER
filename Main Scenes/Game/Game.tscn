[gd_scene load_steps=8 format=2]

[ext_resource path="res://Art/BG.jpg" type="Texture" id=1]
[ext_resource path="res://Art/tuberia.png" type="Texture" id=2]
[ext_resource path="res://Art/piso_agua.png" type="Texture" id=3]
[ext_resource path="res://Main Scenes/Game/InGameMenu.tscn" type="PackedScene" id=4]
[ext_resource path="res://Main Scenes/Game/RiskMeter.tscn" type="PackedScene" id=5]
[ext_resource path="res://Main Scenes/Game/Valvula.tscn" type="PackedScene" id=6]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

onready var early_timer = $EarlyGame
onready var mid_timer = $MidGame
onready var late_timer = $LateGame
onready var leak_timer = $Leak

onready var base_fuga = preload(\"res://Main Scenes/Game/Fuga.tscn\")

onready var points = ($Pipe/Line).points
onready var points_size:int = points.size()
onready var fuga_container = $FugaContainer

var alphabet:Dictionary = {
	65:\"A\", 66:\"B\", 67:\"C\", 68:\"D\", 69:\"E\", 70:\"F\",
	71:\"G\", 72:\"H\", 73:\"I\", 74:\"J\", 75:\"K\", 76:\"L\",
	77:\"M\", 78:\"N\", 79:\"O\", 80:\"P\", 81:\"Q\", 82:\"R\",
	83:\"S\", 84:\"T\", 85:\"U\", 86:\"V\", 87:\"W\", 88:\"X\",
	89:\"Y\", 90:\"Z\"
}

onready var letter_stack:Array = range(65,91)
onready var position_stack:Array = range(0, points_size)

var fugas_counter:int = 0
var keys_to_press:Dictionary = {}

var input_queue:Array = []

func _unhandled_key_input(event:InputEventKey): #filter key presses
	if (event.scancode in keys_to_press.keys()):
		if (!event.echo):
			input_queue.push_back(event)
#			print(alphabet[event.scancode])

func _process(delta):
	if GM.current_state == GM.game_states.PAUSED: 
		return 
	if !input_queue.empty(): #process key press or release
		var event:InputEventKey = input_queue.front()
		if (event.pressed):
			keys_to_press[event.scancode].state = ((keys_to_press[event.scancode].state + 1) % 2)
		input_queue.pop_front()

func _ready():
	randomize()
	letter_stack.shuffle()
	position_stack.shuffle()
	early_timer.start()
	leak_timer.wait_time = ( 5 - GM.DIFFICULTY/3) #DIFICULTY (0, 1, 2) EASY, NORMAL, HARD
	
func _on_EarlyGame_timeout():
	mid_timer.start()
	_on_Leak_timeout()
	leak_timer.start()

func _on_MidGame_timeout():
	late_timer.start()

func _on_LateGame_timeout():
	pass # Replace with function body.

func _on_Leak_timeout():
	if GM.current_state == GM.game_states.PAUSED: 
		return
	if letter_stack.empty() or position_stack.empty():
		return
	var new_fuga = base_fuga.instance()
	fuga_container.add_child(new_fuga)
	new_fuga.position = points[position_stack.front()]
	position_stack.pop_front()
	new_fuga.letter = alphabet[letter_stack.front()]
	keys_to_press[letter_stack.front()] = new_fuga
	letter_stack.pop_front()
	new_fuga.state = GM.EFUGA.SPAWN
	new_fuga.name = new_fuga.letter
	fugas_counter += 1"

[node name="Game" type="Node2D"]
script = SubResource( 1 )

[node name="Pipe" type="Node2D" parent="."]
editor/display_folded = true

[node name="Line" type="Line2D" parent="Pipe"]
points = PoolVector2Array( 214, 150, 264.117, 149.504, 331.132, 148.84, 389.485, 148.263, 486.232, 147.305, 551.037, 146.663, 653.181, 145.652, 719, 145, 715.862, 172.054, 710.266, 209.472, 706, 238, 668.836, 234.345, 620.249, 229.565, 571.661, 224.786, 523, 220, 519, 184, 475.974, 185.14, 418.679, 186.658, 368, 188, 363, 239, 318.341, 240.999, 248.508, 244.124, 211.158, 245.795, 209.713, 278.465, 207.104, 337.464, 205.436, 375.193, 228.783, 376.304, 297.863, 379.594, 300.266, 347.148, 302.748, 313.644, 304.905, 284.526, 332.774, 286.557, 384.714, 290.342, 413.616, 292.449, 414.81, 261.395, 416.257, 223.789, 443.211, 231.897, 470.392, 240.074, 469.71, 265.335, 468.871, 296.373, 468.192, 321.497, 447.654, 322.252, 414.936, 323.453, 385.849, 324.522, 360.361, 325.458, 365.66, 353.436, 371.364, 383.555, 398.024, 383.683, 432.42, 383.849, 462.91, 383.995, 473.739, 363.55, 487.799, 337.005, 503.02, 308.268, 517.926, 280.125, 544.559, 278.192, 572.502, 276.164, 571.976, 304.172, 571.36, 336.934, 570.741, 369.911, 556.721, 397.128, 543.373, 423.043, 512.798, 424.055, 423.022, 427.023, 374.145, 428.64, 317.646, 430.508, 260.974, 432.382, 210.637, 434.047, 217.012, 460.257, 222.52, 482.901, 268.189, 481.32, 312.041, 479.802, 353.915, 478.352, 403.537, 476.635, 450.685, 475.003, 497.059, 473.397, 535.083, 472.081, 565.819, 471.017, 580.972, 443.538, 595.83, 416.593, 610.179, 390.573, 624.796, 364.066, 701.818, 343.821, 699.407, 375.268, 697.043, 406.089, 694.164, 443.636, 691.255, 481.58, 736.168, 481.804, 779.72, 482.02, 779.72, 448.979, 779.72, 403.488, 779.72, 361.602, 779.72, 325.335, 750.144, 320.215, 702.283, 311.928, 667.1, 305.837, 632.278, 299.808, 625.676, 268.999, 668.739, 271.343, 713.895, 273.8, 771.738, 276.948, 819.772, 279.562 )
texture_mode = -1082452802

[node name="Background" type="TextureRect" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
margin_right = 1920.0
margin_bottom = 1080.0
rect_scale = Vector2( 0.563, 0.667 )
mouse_filter = 2
texture = ExtResource( 1 )

[node name="Background2" type="TextureRect" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 150.617
margin_top = 89.5807
margin_right = 1338.62
margin_bottom = 765.581
rect_scale = Vector2( 0.58, 0.6 )
texture = ExtResource( 2 )

[node name="Midground" type="TextureRect" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
margin_left = 1.58472
margin_top = -1.29236
margin_right = 1985.58
margin_bottom = 1078.71
rect_scale = Vector2( 0.563, 0.667 )
mouse_filter = 2
texture = ExtResource( 3 )

[node name="EarlyGame" type="Timer" parent="."]
wait_time = 3.0
one_shot = true

[node name="MidGame" type="Timer" parent="."]
wait_time = 35.0
one_shot = true

[node name="LateGame" type="Timer" parent="."]
wait_time = 20.0
one_shot = true

[node name="Leak" type="Timer" parent="."]

[node name="FugaContainer" type="Node2D" parent="."]

[node name="InGameMenu" parent="." instance=ExtResource( 4 )]

[node name="RiskMeter" parent="." instance=ExtResource( 5 )]
margin_left = 755.06
margin_top = 621.236
margin_right = 755.06
margin_bottom = 621.236
rect_scale = Vector2( 0.25, 0.25 )

[node name="Valvula" parent="." instance=ExtResource( 6 )]
position = Vector2( 937.08, 628.769 )
[connection signal="timeout" from="EarlyGame" to="." method="_on_EarlyGame_timeout"]
[connection signal="timeout" from="MidGame" to="." method="_on_MidGame_timeout"]
[connection signal="timeout" from="LateGame" to="." method="_on_LateGame_timeout"]
[connection signal="timeout" from="Leak" to="." method="_on_Leak_timeout"]
